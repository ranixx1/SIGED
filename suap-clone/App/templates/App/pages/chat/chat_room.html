{% extends "base.html" %}
{% load static %}

{% block 'head' %}
<style>
    /* Estilos básicos para o chat */
    #chat-log {
        height: 400px;
        overflow-y: scroll;
        border: 1px solid #e2e8f0; /* gray-300 */
        border-radius: 0.5rem; /* rounded-lg */
        padding: 1rem;
        background-color: #f8fafc; /* gray-50 */
    }
    .message-bubble {
        margin-bottom: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.75rem;
        max-width: 75%;
        word-wrap: break-word;
    }
    .message-mine {
        background-color: #d1fae5; /* green-100 */
        color: #10b981; /* green-600 */
        margin-left: auto; /* Alinha à direita */
        text-align: right;
    }
    .message-other {
        background-color: #e0f2fe; /* blue-100 */
        color: #2563eb; /* blue-600 */
        margin-right: auto; /* Alinha à esquerda */
    }
    .message-timestamp {
        font-size: 0.75rem;
        color: #6b7280; /* gray-500 */
        margin-top: 0.25rem;
    }
    .message-user {
        font-weight: bold;
        margin-bottom: 0.125rem;
    }
</style>
{% endblock 'head' %}

{% block 'body' %}
<div class="max-w-xl mx-auto p-6 bg-white shadow-lg rounded-lg mt-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Chat: {{ room_name|title }}</h2>

    <div id="chat-log" class="mb-4">
        {% for message in messages %}
            <div class="message-bubble {% if message.user == request.user %}message-mine{% else %}message-other{% endif %}">
                <div class="message-user">{{ message.user.username }}</div>
                <div>{{ message.message }}</div>
                <div class="message-timestamp">{{ message.timestamp|date:"H:i" }}</div>
            </div>
        {% endfor %}
    </div>

    <div class="flex items-center gap-2">
        <input id="chat-message-input" type="text" placeholder="Digite sua mensagem..."
               class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
        <button id="chat-message-submit"
                class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition">
            Enviar
        </button>
    </div>
</div>

<script>
    // Coloque o nome da sala em um elemento HTML para o JavaScript acessar
    // Isso é mais seguro do que passar via JSON.parse(document.getElementById('room-name').textContent)
    // se o room_name puder conter caracteres especiais.
    const roomName = "{{ room_name }}"; 
    const chatLog = document.getElementById('chat-log');
    const messageInput = document.getElementById('chat-message-input');
    const messageSubmit = document.getElementById('chat-message-submit');

    // Scroll para o final do chat ao carregar a página
    chatLog.scrollTop = chatLog.scrollHeight;

    const chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;
        const username = data.username;
        const currentUser = "{{ request.user.username }}"; // Obtém o username do usuário logado

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-bubble';
        
        const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

        if (username === currentUser) {
            messageDiv.classList.add('message-mine');
        } else {
            messageDiv.classList.add('message-other');
        }
        
        messageDiv.innerHTML = `
            <div class="message-user">${username}</div>
            <div>${message}</div>
            <div class="message-timestamp">${timestamp}</div>
        `;
        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight; // Scroll para o final
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    messageInput.focus();
    messageInput.onkeyup = function(e) {
        if (e.keyCode === 13) {  // Enter key
            messageSubmit.click();
        }
    };

    messageSubmit.onclick = function(e) {
        const message = messageInput.value;
        if (message.trim() === '') return; // Não envia mensagens vazias

        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInput.value = '';
    };
</script>
{% endblock 'body' %}